<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Tradebe Molino v9.5</title>

    <style>
        :root { 
            --blue: #0056b3; --green: #89b434; --orange: #e87e04; 
            --light: #f8f9fa; --dark: #2c3e50; --border: #dee2e6;
            --white: #ffffff; --shadow: rgba(0,0,0,0.08);
            --red: #dc3545;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--light); margin: 0; padding: 0; color: var(--dark); }

        /* Secciones mostradas/ocultas */
        .page-section { display: none; }
        .page-section.active { display: block; }

        /* CORRECCI√ìN DEL LOGIN */
        #login-page {
            height: 100vh; 
            display: none;
            align-items: center;
            justify-content: center;
            background: var(--dark);
        }
        #login-page.active {
            display: flex;
        }

        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--white); padding: 12px 30px; 
            box-shadow: 0 2px 10px var(--shadow); border-bottom: 3px solid var(--green);
        }

        .container { padding: 20px; max-width: 1100px; margin: auto; }

        .card { 
            background: var(--white); padding: 25px; border-radius: 12px; 
            border: 1px solid var(--border); margin-bottom: 25px; 
            box-shadow: 0 4px 6px var(--shadow); 
        }

        .section-title { 
            font-size: 0.9em; font-weight: 800; color: var(--blue); 
            border-left: 4px solid var(--orange); padding-left: 10px;
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        input, select { 
            padding: 10px; border: 1px solid #ced4da; border-radius: 6px;
            transition: border-color 0.2s; font-size: 0.95em;
        }

        input:focus { border-color: var(--blue); outline: none; }

        .full-w { width: 100%; box-sizing: border-box; }

        .tabs-nav { display: flex; gap: 5px; margin-bottom: -1px; overflow-x: auto; }
        .tab-btn { 
            padding: 12px 25px; background: #e2e8f0; border: 1px solid var(--border); 
            border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; 
            font-weight: bold; color: #64748b;
        }
        .tab-btn.active { 
            background: var(--white); color: var(--blue); 
            border-top: 3px solid var(--blue); padding-bottom: 13px;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .counters-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; 
            background: #f1f4f8; padding: 20px; border-radius: 10px; 
            margin-bottom: 20px;
        }

        .input-group { 
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--white); padding: 8px 12px; border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .input-group label { font-size: 0.85em; font-weight: 600; color: #64748b; }
        .input-group input { width: 100px; border: none; font-weight: bold; color: var(--blue); font-size: 1.1em; text-align:right; }

        table { width: 100%; border-collapse: collapse; }

        th { background: #f8f9fa; color: #475569; padding: 12px; font-size: 0.8em; text-transform: uppercase; border-bottom: 2px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; }

        .btn { 
            padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; 
            font-weight: bold; display: inline-flex; justify-content: center; width:100%;
        }

        .btn-blue { background: var(--blue); color:white; }
        .btn-green { background: var(--green); color:white; }
        .btn-add { background: #e2e8f0; }
        .btn-del { background:#fee2e2; color:#c00; padding:5px 10px; border-radius:4px; }

        .pos-container { display: flex; flex-direction: column; gap: 5px; margin-top: 8px; }
        .pos-row { display: flex; gap:5px; }
        .pos-input { width:60px; padding:5px; border:1px solid var(--orange); background:#fffaf0; text-align:center; }
        .prov-input { flex:1; padding:5px; border:1px solid #ccc; }

        .login-card { background:white; padding:40px; border-radius:20px; width:340px; box-shadow:0 20px 40px rgba(0,0,0,0.4); }
    </style>
</head>

<body>

    <!-- LOGIN -->
    <div id="login-page" class="page-section active">
        <div class="login-card">
            <h2 style="margin-bottom:25px"><span style="color:var(--orange)">TRADE</span><span style="color:var(--green)">BE</span></h2>

            <div style="font-size:0.8em; margin-bottom:10px; color:gray; font-weight:bold;">ACCESO DE PERSONAL</div>

            <input id="u" class="full-w" placeholder="Usuario" style="margin-bottom:10px">
            <input id="p" class="full-w" type="password" placeholder="Contrase√±a" style="margin-bottom:20px">

            <button id="btnLogin" class="btn btn-blue" onclick="login()">ENTRAR AL SISTEMA</button>

            <div id="load-msg" style="display:none; margin-top:15px; color:var(--orange); font-weight:bold;">‚åõ CONECTANDO...</div>
        </div>
    </div>

    <!-- APP -->
    <div id="app" class="page-section">
        <div class="header">
            <div>
                <span style="color:var(--orange); font-weight:900;">TRADE</span>
                <span style="color:var(--green); font-weight:900;">BE</span>
                <small style="margin-left:10px; color:#999">MOLINO v9.5</small>
            </div>

            <div id="user-tag" style="padding:5px 12px; background:#edf2f7; border-radius:20px; font-weight:bold;"></div>

            <button onclick="logout()" style="cursor:pointer; border:1px solid #ccc; padding:6px 12px; border-radius:6px;">
                Cerrar sesi√≥n
            </button>
        </div>

        <div id="view" class="container"></div>
    </div>

<script>
/* --- TU SCRIPT COMPLETO (SIN MODIFICAR NADA M√ÅS) --- */

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxM7udxef_1WnSxYGbnQrSTit1rjkeGO7X690cCHjvs3sLiI8Xb_mHsTL8KszB-tvkN/exec";

let activos = [], tareas = [], recambios = [], proveedores = [], excelCreds = {}, reporteActual = [];


/* LOGIN */
async function login() {
    const user = document.getElementById('u').value.toLowerCase().trim();
    const pass = document.getElementById('p').value;

    if (!user || !pass) return;

    document.getElementById('btnLogin').disabled = true;
    document.getElementById('load-msg').style.display = "block";

    try {
        const response = await fetch(SCRIPT_URL);
        const data = await response.json();

        activos = data.activos;
        tareas = data.tareas;
        recambios = data.recambios || [];
        proveedores = data.proveedores || [];
        excelCreds = data.credenciales;

        if ((user === 'admin' && pass === '1234') || (excelCreds[user] && excelCreds[user].toString() === pass)) {

            /* OCULTAR LOGIN ‚Äì MOSTRAR APP */
            document.getElementById('login-page').classList.remove('active');
            document.getElementById('app').classList.add('active');

            if (user === 'admin') renderAdmin();
            else renderOperario(user);

        } else {
            alert("Credenciales incorrectas");
            document.getElementById('btnLogin').disabled = false;
        }

    } catch (e) {
        alert("Error de red");
        document.getElementById('btnLogin').disabled = false;
    }
}
    
/* RESTO DEL C√ìDIGO SIN CAMBIOS */

function logout(){ location.reload(); }

function switchTab(tabId){
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.currentTarget.classList.add('active');
}

function renderOperario(name){
    const todayISO = new Date().toISOString().split("T")[0];

    document.getElementById("user-tag").innerText = "üë§ " + name.toUpperCase();

    document.getElementById("view").innerHTML = `
        <div class="card" style="padding:15px 25px; margin-bottom:15px;">
            <div style="display:flex; gap:20px; align-items:center; flex-wrap:wrap;">
                <div style="flex:1; min-width:120px;">
                    <label style="font-size:0.75em; font-weight:bold; color:#64748b;">TURNO</label><br>
                    <select id="f_turno" class="full-w" onchange="resetHoras()">
                        <option>Ma√±ana</option>
                        <option>Tarde</option>
                    </select>
                </div>

                <div style="flex:1; min-width:120px;">
                    <label style="font-size:0.75em; font-weight:bold; color:#64748b;">FECHA</label><br>
                    <input type="date" id="f_fecha" class="full-w" value="${todayISO}">
                </div>
            </div>
        </div>

        <div class="tabs-nav">
            <button class="tab-btn active" onclick="switchTab('tab-parte')">PARTE DE TRABAJO</button>
            <button class="tab-btn" onclick="switchTab('tab-incidencias')">INCIDENCIAS</button>
            <button class="tab-btn" onclick="switchTab('tab-recambios-div')">RECAMBIOS</button>
        </div>

        <div id="tab-parte" class="tab-content active card">
            <div class="section-title">Lectura de Contadores</div>
            <input id="f_lote" class="full-w" placeholder="N¬∫ LOTE / ORDEN" style="margin-bottom:15px">

            <div class="counters-grid">
                <div>
                    <div class="input-group"><label>H. Molino I</label><input id="hmi" type="number" step="0.01"></div>
                    <div class="input-group"><label>H. Prod I</label><input id="hpi" type="number" step="0.01"></div>
                    <div class="input-group"><label>Z1 (kg) I</label><input id="z1i" type="number" step="0.001"></div>
                    <div class="input-group"><label>Z2 (un.) I</label><input id="z2i" type="number"></div>
                </div>

                <div>
                    <div class="input-group"><label>H. Molino F</label><input id="hmf" type="number" step="0.01"></div>
                    <div class="input-group"><label>H. Prod F</label><input id="hpf" type="number" step="0.01"></div>
                    <div class="input-group"><label>Z1 (kg) F</label><input id="z1f" type="number" step="0.001"></div>
                    <div class="input-group"><label>Z2 (un.) F</label><input id="z2f" type="number"></div>
                </div>
            </div>

            <button class="btn btn-blue" onclick="enviar('parte')">ENVIAR LECTURAS</button>
        </div>

        <div id="tab-incidencias" class="tab-content card">
            <div class="section-title">Registro de Tareas</div>
            <table id="t-tareas">
                <thead><tr>
                    <th>Parada</th><th>Arranque</th><th>Tarea</th><th>Activo</th><th>Obs</th><th></th>
                </tr></thead>
                <tbody></tbody>
            </table>

            <button class="btn btn-add" onclick="addFila()">+ A√±adir l√≠nea</button>
            <button class="btn btn-blue" style="background:var(--orange); margin-top:15px;" onclick="enviar('incidencias')">ENVIAR TAREAS</button>
        </div>

        <div id="tab-recambios-div" class="tab-content card">
            <div class="section-title">Consumo de Materiales</div>

            <table id="t-recambios">
                <thead><tr>
                    <th>Recambio</th><th>Detalles</th><th></th>
                </tr></thead>
                <tbody></tbody>
            </table>

            <button class="btn btn-add" onclick="addRecambio()">+ A√±adir recambio</button>
            <button class="btn btn-green" style="margin-top:15px;" onclick="enviar('recambios')">REGISTRAR RECAMBIOS</button>
        </div>
    `;

    addFila();
    addRecambio();
}

function addFila(){
    const h = genH();
    const r = document.querySelector("#t-tareas tbody").insertRow();

    r.innerHTML = `
        <td><select class="p full-w">${h}</select></td>
        <td><select class="a full-w">${h}</select></td>
        <td><select class="full-w">${tareas.map(t => `<option>${t}</option>`).join("")}</select></td>
        <td><select class="full-w">${activos.map(a => `<option>${a}</option>`).join("")}</select></td>
        <td><input class="obs full-w"></td>
        <td><button class="btn-del" onclick="this.parentNode.parentNode.remove()">‚úï</button></td>
    `;
}

function addRecambio(){
    const r = document.querySelector("#t-recambios tbody").insertRow();

    r.innerHTML = `
        <td>
            <select class="r-item full-w" onchange="handleRecambioChange(this)">
                <option value="">-- Seleccionar --</option>
                ${recambios.map(r => `<option>${r}</option>`).join("")}
            </select>
        </td>

        <td>
            <input class="r-cant full-w" type="number" placeholder="Cantidad" oninput="handleCantChange(this)">
            <div class="pos-container"></div>
        </td>

        <td><button class="btn-del" onclick="this.parentNode.parentNode.remove()">‚úï</button></td>
    `;
}

function handleRecambioChange(sel){
    handleCantChange(sel.parentNode.nextElementSibling.querySelector(".r-cant"));
}

function handleCantChange(input){
    const row = input.closest("tr");
    const item = row.querySelector(".r-item").value.toLowerCase();
    const container = row.querySelector(".pos-container");
    const cant = parseInt(input.value) || 0;

    container.innerHTML = "";

    if ((item.includes("placa") || item.includes("martillo")) && cant > 0) {
        for (let i = 0; i < cant; i++) {

            const div = document.createElement("div");
            div.className = "pos-row";

            const pos = document.createElement("input");
            pos.type = "number";
            pos.className = "pos-input";
            pos.placeholder = "Pos";

            const prov = document.createElement("select");
            prov.className = "prov-input";
            prov.innerHTML = `<option value="">Fabricante...</option>` +
                proveedores.map(p => `<option>${p}</option>`).join("");

            div.appendChild(pos);
            div.appendChild(prov);

            container.appendChild(div);
        }
    }
}

function genH(){
    const t = document.getElementById('f_turno').value;
    let i = t === "Ma√±ana" ? 6 : 14;
    let f = t === "Ma√±ana" ? 14 : 22;

    let html = `<option value="">--:--</option>`;

    for (let h = i; h <= f; h++) {
        for (let m = 0; m < 60; m += 5) {
            if (h === f && m > 0) break;
            let hh = String(h).padStart(2,"0") + ":" + String(m).padStart(2,"0");
            html += `<option>${hh}</option>`;
        }
    }
    return html;
}

function resetHoras(){
    document.querySelectorAll("#t-tareas select.p, #t-tareas select.a")
        .forEach(s => s.innerHTML = genH());
}

async function enviar(tipo){
    const btn = event.target;
    const original = btn.innerText;

    const rawFecha = document.getElementById("f_fecha").value;
    const [y,m,d] = rawFecha.split("-");
    const fecha = `${d}/${m}/${y}`;

    let data = {
        fecha,
        turno: document.getElementById("f_turno").value,
        operario: document.getElementById("user-tag").innerText.replace("üë§ ",""),
        tipo,
        lote: document.getElementById("f_lote")?.value || "N/A"
    };

    if (tipo === "parte") {
        data.h_mol_ini = hmi.value;
        data.h_prod_ini = hpi.value;
        data.z1_ini = z1i.value;
        data.z2_ini = z2i.value;
        data.h_mol_fin = hmf.value;
        data.h_prod_fin = hpf.value;
        data.z1_fin = z1f.value;
        data.z2_fin = z2f.value;
    }

    if (tipo === "incidencias") {
        data.tareas = Array.from(document.querySelectorAll("#t-tareas tbody tr"))
            .map(tr => ({
                p: tr.querySelector(".p").value,
                a: tr.querySelector(".a").value,
                t: tr.cells[2].querySelector("select").value,
                ac: tr.cells[3].querySelector("select").value,
                o: tr.querySelector(".obs").value
            }))
            .filter(t => t.p !== "");
    }

    if (tipo === "recambios") {
        data.recambios = Array.from(document.querySelectorAll("#t-recambios tbody tr"))
            .map(tr => ({
                item: tr.querySelector(".r-item").value,
                cant: tr.querySelector(".r-cant").value,
                detalles: Array.from(tr.querySelectorAll(".pos-row")).map(r => ({
                    pos: r.querySelector(".pos-input").value,
                    prov: r.querySelector(".prov-input").value
                }))
            }))
            .filter(r => r.item !== "");
    }

    if (!confirm("¬øEnviar datos?")) return;

    btn.disabled = true;
    btn.innerText = "Enviando...";

    try {
        await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) });

        alert("‚úî Datos enviados");

        if (tipo === "parte") {
            ["f_lote","hmi","hpi","z1i","z2i","hmf","hpf","z1f","z2f"]
                .forEach(id => document.getElementById(id).value = "");
        }

        if (tipo === "incidencias") {
            document.querySelector("#t-tareas tbody").innerHTML = "";
            addFila();
        }

        if (tipo === "recambios") {
            document.querySelector("#t-recambios tbody").innerHTML = "";
            addRecambio();
        }

    } catch (e){
        alert("Error enviando");
    }

    btn.disabled = false;
    btn.innerText = original;
}


/* ------------------- MODO ADMIN ------------------- */

function renderAdmin(){
    document.getElementById("user-tag").innerText = "‚öôÔ∏è ADMINISTRADOR";

    document.getElementById("view").innerHTML = `
        <div class="card">
            <div class="section-title">Gesti√≥n de Maestros</div>

            <div style="display:grid; grid-template-columns:1fr 1fr 1.3fr; gap:15px;">
                
                <div>
                    <label>Nueva Tarea</label>
                    <input id="nT" class="full-w" style="margin-bottom:5px">
                    <button class="btn btn-blue" onclick="addExt('addTarea','nT')">A√±adir</button>
                </div>

                <div>
                    <label>Nuevo Activo</label>
                    <input id="nA" class="full-w" style="margin-bottom:5px">
                    <button class="btn btn-blue" onclick="addExt('addActivo','nA')">A√±adir</button>
                </div>

                <div>
                    <label>Nuevo Operario</label>
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <input id="nOp" placeholder="usuario" class="full-w">
                        <input id="pOp" placeholder="pass" class="full-w">
                    </div>
                    <button class="btn btn-green" onclick="addOperario()">Crear</button>
                </div>

            </div>
        </div>

        <div class="card">
            <div class="section-title">Hist√≥rico de Parte</div>

            <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                <div><label>Desde</label><br><input type="date" id="f_ini"></div>
                <div><label>Hasta</label><br><input type="date" id="f_fin"></div>

                <button class="btn btn-blue" onclick="generarReporte()">CONSULTAR</button>
                <button id="btnDownload" class="btn btn-green" style="display:none;" onclick="descargarCSV()">DESCARGAR EXCEL</button>
            </div>

            <div style="margin-top:20px; border:1px solid #eee; max-height:350px; overflow-y:auto;">
                <div id="report-output"></div>
            </div>
        </div>
    `;
}

async function addExt(acc, inp){
    const val = document.getElementById(inp).value;
    if (!val) return;

    fetch(SCRIPT_URL, { method:"POST", mode:"no-cors", body:JSON.stringify({accion:acc, valor:val}) });
    alert("Guardado");
    document.getElementById(inp).value = "";
}

async function addOperario(){
    const nombre = document.getElementById("nOp").value.toLowerCase().trim();
    const pass = document.getElementById("pOp").value;

    if (!nombre || !pass) return;

    fetch(SCRIPT_URL, { method:"POST", mode:"no-cors", body:JSON.stringify({accion:"addOperario", nombre, pass}) });

    alert("Operario creado");
    document.getElementById("nOp").value = "";
    document.getElementById("pOp").value = "";
}

async function generarReporte(){
    const fini = document.getElementById("f_ini").value;
    const ffin = document.getElementById("f_fin").value;
    const out = document.getElementById("report-output");

    if (!fini || !ffin) return;

    out.innerHTML = "<div style='padding:20px; text-align:center; color:gray'>Consultando...</div>";
    document.getElementById("btnDownload").style.display = "none";

    try {
        const res = await fetch(SCRIPT_URL + "?action=getReport");
        const dataRows = await res.json();

        reporteActual = [];

        let html = `<table style="min-width:900px;"><thead><tr>
            <th>Fecha</th><th>Turno</th><th>Operario</th><th>Lote</th>
            <th>H Mol I</th><th>H Prod I</th><th>Z1 I</th><th>Z2 I</th>
            <th>H Mol F</th><th>H Prod F</th><th>Z1 F</th><th>Z2 F</th>
        </tr></thead><tbody>`;

        const finiD = new Date(fini);
        const ffinD = new Date(ffin);

        dataRows.forEach(r => {
            const [dd,mm,yy] = r[0].split("/");
            const d = new Date(`${yy}-${mm}-${dd}`);

            if (d >= finiD && d <= ffinD) {
                reporteActual.push(r);
                html += `<tr>${r.map(c => `<td>${c}</td>`).join("")}</tr>`;
            }
        });

        html += "</tbody></table>";

        out.innerHTML = html;
        if (reporteActual.length > 0) document.getElementById("btnDownload").style.display = "block";

    } catch (e) {
        out.innerHTML = "Error cargando datos";
    }
}

function descargarCSV(){
    let csv = "sep=;\nFecha;Turno;Operario;Lote;H_Mol_I;H_Prod_I;Z1_I;Z2_I;H_Mol_F;H_Prod_F;Z1_F;Z2_F\n";

    reporteActual.forEach(r => {
        csv += r.slice(0,15).join(";") + "\n";
    });

    const blob = new Blob(["\ufeff" + csv], { type:"text/csv;charset=utf-8;" });

    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Reporte_Tradebe.csv";
    link.click();
}

</script>

</body>
</html>
