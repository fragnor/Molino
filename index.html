<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Tradebe Molino v11.6</title>
    <style>
        :root { 
            --blue: #0056b3; --green: #89b434; --orange: #e87e04; 
            --light: #f8f9fa; --dark: #2c3e50; --border: #dee2e6;
            --white: #ffffff; --shadow: rgba(0,0,0,0.08);
            --red: #dc3545; --danger-bg: #fff5f5; --danger-border: #feb2b2;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--light); margin: 0; padding: 0; color: var(--dark); }

        .page-section { display: none; }
        .page-section.active { display: block; }

        #login-page {
            height: 100vh; display: none; align-items: center; justify-content: center; background: var(--dark);
        }
        #login-page.active { display: flex; }

        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--white); padding: 12px 30px; 
            box-shadow: 0 2px 10px var(--shadow); border-bottom: 3px solid var(--green);
        }

        .container { padding: 20px; max-width: 1100px; margin: auto; }

        .card { 
            background: var(--white); padding: 25px; border-radius: 12px; 
            border: 1px solid var(--border); margin-bottom: 25px; 
            box-shadow: 0 4px 6px var(--shadow); 
        }

        .section-title { 
            font-size: 0.9em; font-weight: 800; color: var(--blue); 
            border-left: 4px solid var(--orange); padding-left: 10px;
            margin-bottom: 20px; text-transform: uppercase;
        }

        input, select, textarea { 
            padding: 10px; border: 1px solid #ced4da; border-radius: 6px;
            transition: border-color 0.2s; font-size: 0.95em; width: 100%; box-sizing: border-box;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--blue); outline: none; }
        
        .tabs-nav { display: flex; gap: 5px; margin-bottom: -1px; overflow-x: auto; }
        .tab-btn { 
            padding: 12px 25px; background: #e2e8f0; border: 1px solid var(--border); 
            border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; 
            font-weight: bold; color: #64748b; white-space: nowrap;
        }
        .tab-btn.active { 
            background: var(--white); color: var(--blue); 
            border-top: 3px solid var(--blue); padding-bottom: 13px;
        }
        .tab-btn.danger { color: #c53030; }
        .tab-btn.danger.active { border-top-color: #c53030; color: #c53030; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .counters-grid { 
            display: grid; grid-template-columns: 1fr; gap: 20px; 
            background: #f1f4f8; padding: 20px; border-radius: 10px; margin-bottom: 20px;
        }

        .input-group { 
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--white); padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0; margin-bottom: 10px;
        }
        .input-group label { font-size: 1em; font-weight: 600; color: #64748b; }
        .input-group input { width: 150px; border: none; font-weight: bold; color: var(--blue); font-size: 1.3em; text-align:right; border-bottom: 2px solid #eee; }

        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; color: #475569; padding: 12px; font-size: 0.8em; text-transform: uppercase; border-bottom: 2px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; }

        .btn { 
            padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; 
            font-weight: bold; display: inline-flex; justify-content: center; width:100%;
        }
        .btn-blue { background: var(--blue); color:white; }
        .btn-green { background: var(--green); color:white; }
        .btn-red { background: var(--red); color:white; }
        .btn-add { background: #e2e8f0; }
        .btn-del { background:#fee2e2; color:#c00; padding:5px 10px; border-radius:4px; width:auto; }
        .btn-trash { background:transparent; border:none; cursor:pointer; font-size:1.2em; }

        .pos-container { display: flex; flex-direction: column; gap: 5px; margin-top: 8px; }
        .pos-row { display: flex; gap:5px; }
        .pos-input { width:60px; padding:5px; border:1px solid var(--orange); background:#fffaf0; text-align:center; }
        .prov-input { flex:1; padding:5px; border:1px solid #ccc; }

        .login-card { background:white; padding:40px; border-radius:20px; width:340px; box-shadow:0 20px 40px rgba(0,0,0,0.4); }

        /* Estilos Burbujas */
        .bubble-info {
            background-color: #fff9db; border: 1px solid #ffe066; border-radius: 10px;
            padding: 15px; margin-top: 25px;
        }
        .bubble-blue {
            background-color: #e3f2fd; border: 1px solid #90caf9; border-radius: 10px;
            padding: 15px; margin-top: 25px;
        }
        .bubble-title { color: #d48806; font-weight: bold; font-size: 0.9em; margin-bottom: 10px; display: block; }
        .bubble-title-blue { color: #1976d2; font-weight: bold; font-size: 0.9em; margin-bottom: 10px; display: block; }
        
        .info-table { width: 100%; font-size: 0.85em; }
        .info-table td { padding: 6px; border-bottom: 1px solid #fae39d; color: #555; }
        .info-table th { background: transparent; color: #d48806; border-bottom: 2px solid #fae39d; padding: 6px; text-align: left; }

        /* Estilo Historial Prod */
        .prod-cards { display: flex; gap: 10px; justify-content: space-between; }
        .prod-card { 
            background: white; flex:1; padding:10px; border-radius:8px; text-align:center; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative;
        }
        .prod-date { font-size:0.8em; color:#777; font-weight:bold; }
        .prod-turn { font-size:0.9em; color:#333; margin:2px 0; }
        .prod-val { font-size:1.1em; color:var(--blue); font-weight:900; }
        .prod-tag { 
            font-size: 0.65em; text-transform: uppercase; letter-spacing: 0.5px;
            background: #edf2f7; color: #718096; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 4px;
        }
        .prod-card:last-child { border: 2px solid var(--green); }
        .prod-card:last-child .prod-tag { background: var(--green); color: white; }
    </style>
</head>

<body>

    <div id="login-page" class="page-section active">
        <div class="login-card">
            <h2 style="margin-bottom:25px"><span style="color:var(--orange)">TRADE</span><span style="color:var(--green)">BE</span></h2>
            <div style="font-size:0.8em; margin-bottom:10px; color:gray; font-weight:bold;">ACCESO DE PERSONAL</div>
            <input id="u" placeholder="Usuario" style="margin-bottom:10px">
            <input id="p" type="password" placeholder="Contrase√±a" style="margin-bottom:20px">
            <button id="btnLogin" class="btn btn-blue" onclick="login()">ENTRAR AL SISTEMA</button>
            <div id="load-msg" style="display:none; margin-top:15px; color:var(--orange); font-weight:bold;">‚åõ CONECTANDO...</div>
        </div>
    </div>

    <div id="app" class="page-section">
        <div class="header">
            <div>
                <span style="color:var(--orange); font-weight:900;">TRADE</span>
                <span style="color:var(--green); font-weight:900;">BE</span>
                <small style="margin-left:10px; color:#999">MOLINO v11.6</small>
            </div>
            <div id="user-tag" style="padding:5px 12px; background:#edf2f7; border-radius:20px; font-weight:bold;"></div>
            <button onclick="logout()" style="cursor:pointer; border:1px solid #ccc; padding:6px 12px; border-radius:6px; background:white;">Cerrar sesi√≥n</button>
        </div>
        <div id="view" class="container"></div>
    </div>

<script>
// ACTUALIZA ESTA URL SI CAMBIA
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxYANQ1Fz-wwhfAhKrmbdQk6KZch5TfPfbNRubMwtlhtgBLn7QtsCrbBWPszcmUrdpP/exec";

let activos = [], tareas = [], recambios = [], proveedores = [];
let tiposExplosion = [], nivelesEstallido = [], nivelesFuego = [];
let excelCreds = {}, reporteActual = [];
let currentUser = "";

/* LOGIN */
async function login() {
    const user = document.getElementById('u').value.toLowerCase().trim();
    const pass = document.getElementById('p').value;

    if (!user || !pass) return;

    document.getElementById('btnLogin').disabled = true;
    document.getElementById('load-msg').style.display = "block";

    try {
        const response = await fetch(SCRIPT_URL);
        const data = await response.json();

        activos = data.activos;
        tareas = data.tareas;
        recambios = data.recambios || [];
        proveedores = data.proveedores || [];
        
        tiposExplosion = data.tiposExplosion || [];
        nivelesEstallido = data.nivelesEstallido || [];
        nivelesFuego = data.nivelesFuego || [];
        
        excelCreds = data.credenciales;

        if ((user === 'admin' && pass === '1234') || (user === 'jordi' && pass === 'jordi2') || (excelCreds[user] && excelCreds[user].toString() === pass)) {
            
            currentUser = user;
            document.getElementById('login-page').classList.remove('active');
            document.getElementById('app').classList.add('active');

            if (user === 'admin') renderAdmin();
            else if (user === 'jordi') renderJordi();
            else {
                renderOperario(user);
                cargarIncidenciasAnteriores(); 
                cargarIncidenciasHoy();
                cargarHistorialProd();
            }

        } else {
            alert("Credenciales incorrectas");
            document.getElementById('btnLogin').disabled = false;
        }

    } catch (e) {
        alert("Error de red");
        document.getElementById('btnLogin').disabled = false;
    }
}
    
function logout(){ location.reload(); }

function switchTab(tabId){
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.currentTarget.classList.add('active');
}

function renderOperario(name){
    const todayISO = new Date().toISOString().split("T")[0];
    
    // L√≥gica Autom√°tica de Turno
    const currentHour = new Date().getHours();
    let turnoAuto = "Ma√±ana";
    if (currentHour >= 14 && currentHour < 22) {
        turnoAuto = "Tarde";
    } else if (currentHour >= 22 || currentHour < 6) {
        turnoAuto = "Tarde"; 
    }

    document.getElementById("user-tag").innerText = "üë§ " + name.toUpperCase();

    document.getElementById("view").innerHTML = `
        <div class="card" style="padding:15px 25px; margin-bottom:15px;">
            <div style="display:flex; gap:20px; align-items:center; flex-wrap:wrap;">
                <div style="flex:1; min-width:120px;">
                    <label style="font-size:0.75em; font-weight:bold; color:#64748b;">TURNO</label><br>
                    <select id="f_turno" onchange="resetHoras()">
                        <option ${turnoAuto === 'Ma√±ana' ? 'selected' : ''}>Ma√±ana</option>
                        <option ${turnoAuto === 'Tarde' ? 'selected' : ''}>Tarde</option>
                    </select>
                </div>
                <div style="flex:1; min-width:120px;">
                    <label style="font-size:0.75em; font-weight:bold; color:#64748b;">FECHA</label><br>
                    <input type="date" id="f_fecha" value="${todayISO}">
                </div>
            </div>
        </div>

        <div class="tabs-nav">
            <button class="tab-btn active" onclick="switchTab('tab-parte')">PARTE DE TRABAJO</button>
            <button class="tab-btn" onclick="switchTab('tab-incidencias')">INCIDENCIAS</button>
            <button class="tab-btn" onclick="switchTab('tab-recambios-div')">RECAMBIOS</button>
            <button class="tab-btn danger" onclick="switchTab('tab-explosiones')">üí• EXPLOSIONES</button>
        </div>

        <div id="tab-parte" class="tab-content active card">
            <div class="section-title">Datos Fin de Turno</div>
            <input id="f_lote" placeholder="N¬∫ LOTE / ORDEN" style="margin-bottom:15px">

            <div class="counters-grid">
                <div class="input-group">
                    <label>H. Molino Final</label>
                    <input id="hmf" type="number" step="0.01" placeholder="valor">
                </div>
                <div class="input-group">
                    <label>H. Prod Final</label>
                    <input id="hpf" type="number" step="0.01" placeholder="valor">
                </div>
                <div class="input-group" style="border-color:var(--green); background:#f0fff4;">
                    <label style="color:var(--green);">Toneladas Prod.</label>
                    <input id="t_prod" type="number" step="0.01" placeholder="valor" style="background:#f0fff4; color:var(--green);">
                </div>
            </div>

            <button class="btn btn-blue" onclick="enviarTodo()">ENVIAR DATOS (Todas las pesta√±as)</button>

            <div class="bubble-blue" id="hist-prod-container" style="display:none;">
                <span class="bubble-title-blue">üìä Producci√≥n Reciente (Calculada)</span>
                <div id="hist-prod-content" class="prod-cards">
                    <i style="color:gray; font-size:0.8em; width:100%; text-align:center">Cargando datos...</i>
                </div>
            </div>
        </div>

        <div id="tab-incidencias" class="tab-content card">
            <div class="section-title">Registro de Tareas</div>
            <table id="t-tareas">
                <thead><tr>
                    <th>Parada</th><th>Arranque</th><th>Tarea</th><th>Activo</th><th>Obs</th><th></th>
                </tr></thead>
                <tbody></tbody>
            </table>

            <button class="btn btn-add" onclick="addFila()">+ A√±adir l√≠nea</button>
            <button class="btn btn-blue" style="background:var(--orange); margin-top:15px;" onclick="enviarTodo()">ENVIAR DATOS (Todas las pesta√±as)</button>
            
            <div class="bubble-blue" id="hoy-container" style="display:none; background:#e6fffa; border-color:#4fd1c5;">
                <span class="bubble-title-blue" style="color:#285e61;">üìù Mis incidencias de hoy</span>
                <div id="hoy-content" style="max-height:200px; overflow-y:auto;">
                     <i style="color:gray;">Cargando...</i>
                </div>
            </div>

            <div class="bubble-info" id="ayer-container" style="display:none;">
                <span id="titulo-ayer" class="bubble-title">üìÖ √öltimo d√≠a productivo</span>
                <div id="ayer-content" style="max-height:200px; overflow-y:auto;">
                    <i style="color:gray; font-size:0.9em;">Buscando historial...</i>
                </div>
            </div>

        </div>

        <div id="tab-recambios-div" class="tab-content card">
            <div class="section-title">Consumo de Materiales</div>
            <table id="t-recambios">
                <thead><tr><th>Recambio</th><th>Detalles</th><th></th></tr></thead>
                <tbody></tbody>
            </table>
            <button class="btn btn-add" onclick="addRecambio()">+ A√±adir recambio</button>
            <button class="btn btn-green" style="margin-top:15px;" onclick="enviarTodo()">ENVIAR DATOS (Todas las pesta√±as)</button>
        </div>

        <div id="tab-explosiones" class="tab-content card" style="border-color:var(--danger-border); background:var(--danger-bg);">
            <div class="section-title" style="color:var(--red); border-color:var(--red);">‚ö†Ô∏è Registro de Incidente (Explosi√≥n)</div>
            
            <label style="font-weight:bold; color:#742a2a">Material introducido</label>
            <input id="exp_material" placeholder="Descripci√≥n del material" style="margin-bottom:15px;">
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                 <div>
                    <label style="font-weight:bold; color:#742a2a">Tipo de Explosi√≥n</label>
                    <select id="exp_tipo">
                        <option value="">-- Seleccionar --</option>
                        ${tiposExplosion.map(t => `<option>${t}</option>`).join("")}
                    </select>
                 </div>
                 <div>
                    <label style="font-weight:bold; color:#742a2a">Origen</label>
                    <input id="exp_origen" placeholder="Proveedor">
                 </div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="font-weight:bold; color:#742a2a">Estallido</label>
                    <select id="exp_estallido">
                        <option value="">-- Selec --</option>
                        ${nivelesEstallido.map(n => `<option>${n}</option>`).join("")}
                    </select>
                </div>
                <div>
                    <label style="font-weight:bold; color:#742a2a">Fuego</label>
                    <select id="exp_fuego">
                        <option value="">-- Selec --</option>
                        ${nivelesFuego.map(n => `<option>${n}</option>`).join("")}
                    </select>
                </div>
                <div>
                    <label style="font-weight:bold; color:#742a2a">Tiempo Parada</label>
                    <select id="exp_parada">
                        <option value="1">Menos de 1 hora</option>
                        <option value="2">Entre 1 y 3 horas</option>
                        <option value="3">M√°s de 3 horas</option>
                    </select>
                </div>
            </div>

            <label style="font-weight:bold; color:#742a2a">Da√±os y Coste Econ√≥mico</label>
            <textarea id="exp_danos" rows="2" placeholder="Describir da√±os y coste estimado" style="margin-bottom:15px;"></textarea>

            <label style="font-weight:bold; color:#742a2a">Observaciones</label>
            <textarea id="exp_obs" rows="2" placeholder="Detalles adicionales..." style="margin-bottom:20px;"></textarea>

            <button class="btn btn-red" onclick="enviarTodo()">ENVIAR DATOS (Todas las pesta√±as)</button>
        </div>
    `;

    addFila();
    addRecambio();
}

/* --------------- CARGA DE DATOS ASINCRONA --------------- */

async function cargarHistorialProd() {
    const cont = document.getElementById("hist-prod-container");
    const div = document.getElementById("hist-prod-content");
    if(cont) cont.style.display = "block";

    try {
        const res = await fetch(SCRIPT_URL + "?action=getUltimosPartes");
        const data = await res.json();

        if(!data || data.length === 0) {
            div.innerHTML = "<small>No hay datos previos.</small>";
            return;
        }

        let html = "";
        const labels = ["Antepen√∫ltimo", "Pen√∫ltimo", "√öltimo"];
        const offset = 3 - data.length;

        data.forEach((d, i) => {
            let label = labels[i + offset] || "";
            html += `
                <div class="prod-card">
                    <div class="prod-tag">${label}</div>
                    <div class="prod-date">${d.fecha}</div>
                    <div class="prod-turn">${d.turno}</div>
                    <div class="prod-val">${d.ton} t</div>
                </div>
            `;
        });
        div.innerHTML = html;

    } catch(e) { div.innerHTML = "Error datos"; }
}

async function cargarIncidenciasHoy() {
    const cont = document.getElementById("hoy-container");
    const div = document.getElementById("hoy-content");
    if(cont) cont.style.display = "block";

    try {
        const res = await fetch(`${SCRIPT_URL}?action=getIncidenciasHoy&user=${currentUser}`);
        const data = await res.json();

        if(!data || data.length === 0) {
            div.innerHTML = "<small style='color:#666'>A√∫n no has creado incidencias hoy.</small>";
            return;
        }

        let html = `<table class="info-table" style="border-collapse:collapse">`;
        data.forEach(d => {
            html += `<tr>
                <td style="width:20px"><button class="btn-trash" onclick="borrarFila('${d.id}')">üóëÔ∏è</button></td>
                <td><b>${d.hora}</b></td>
                <td>${d.tarea}</td>
                <td>${d.activo}</td>
                <td><small>${d.obs}</small></td>
            </tr>`;
        });
        html += "</table>";
        div.innerHTML = html;

    } catch(e) { div.innerHTML = "Error cargando."; }
}

async function cargarIncidenciasAnteriores() {
    const cont = document.getElementById("ayer-container");
    const div = document.getElementById("ayer-content");
    const titulo = document.getElementById("titulo-ayer");
    
    if(cont) cont.style.display = "block";

    try {
        const res = await fetch(SCRIPT_URL + "?action=getIncidenciasAnteriores");
        const respuesta = await res.json();
        
        if (respuesta.fechaRef) titulo.innerText = "üìÖ Incidencias del " + respuesta.fechaRef;

        const data = respuesta.datos || [];
        if (!data || data.length === 0) {
            div.innerHTML = "<div style='color:#b58900; font-style:italic;'>Sin datos anteriores encontrados.</div>";
            return;
        }

        let html = `<table class="info-table"><thead><tr><th>Hora</th><th>Tarea</th><th>Activo</th><th>Obs</th></tr></thead><tbody>`;
        data.forEach(d => {
            html += `<tr>
                <td style="white-space:nowrap;">${d.hora}</td>
                <td><b>${d.tarea}</b></td>
                <td>${d.activo}</td>
                <td><small>${d.obs}</small></td>
            </tr>`;
        });
        html += `</tbody></table>`;
        div.innerHTML = html;
    } catch (e) { div.innerHTML = "Error cargando historial."; }
}

async function borrarFila(rowId) {
    if(!confirm("¬øSeguro que quieres borrar esta incidencia?")) return;
    const div = document.getElementById("hoy-content"); div.style.opacity = "0.5";
    try {
        await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ accion: "borrarIncidencia", row: rowId, user: currentUser }) });
        setTimeout(() => { cargarIncidenciasHoy(); div.style.opacity = "1"; }, 1500);
    } catch(e) { alert("Error al borrar"); div.style.opacity = "1"; }
}

/* --------------- FUNCIONES GENERALES --------------- */

function addFila(){
    const h = genH();
    const r = document.querySelector("#t-tareas tbody").insertRow();
    r.innerHTML = `
        <td><select class="p full-w">${h}</select></td>
        <td><select class="a full-w">${h}</select></td>
        <td><select class="full-w">${tareas.map(t => `<option>${t}</option>`).join("")}</select></td>
        <td><select class="full-w">${activos.map(a => `<option>${a}</option>`).join("")}</select></td>
        <td><input class="obs full-w"></td>
        <td><button class="btn-del" onclick="this.parentNode.parentNode.remove()">‚úï</button></td>
    `;
}

function addRecambio(){
    const r = document.querySelector("#t-recambios tbody").insertRow();
    r.innerHTML = `
        <td>
            <select class="r-item full-w" onchange="handleRecambioChange(this)">
                <option value="">-- Seleccionar --</option>
                ${recambios.map(r => `<option>${r}</option>`).join("")}
            </select>
        </td>
        <td>
            <input class="r-cant full-w" type="number" placeholder="Cantidad" oninput="handleCantChange(this)">
            <div class="pos-container"></div>
        </td>
        <td><button class="btn-del" onclick="this.parentNode.parentNode.remove()">‚úï</button></td>
    `;
}

function handleRecambioChange(sel){ handleCantChange(sel.parentNode.nextElementSibling.querySelector(".r-cant")); }

function handleCantChange(input){
    const row = input.closest("tr");
    const item = row.querySelector(".r-item").value.toLowerCase();
    const container = row.querySelector(".pos-container");
    const cant = parseInt(input.value) || 0;
    container.innerHTML = "";
    if ((item.includes("placa") || item.includes("martillo")) && cant > 0) {
        for (let i = 0; i < cant; i++) {
            const div = document.createElement("div"); div.className = "pos-row";
            const pos = document.createElement("input"); pos.type = "number"; pos.className = "pos-input"; pos.placeholder = "Pos";
            const prov = document.createElement("select"); prov.className = "prov-input";
            prov.innerHTML = `<option value="">Fabricante...</option>` + proveedores.map(p => `<option>${p}</option>`).join("");
            div.appendChild(pos); div.appendChild(prov);
            container.appendChild(div);
        }
    }
}

function genH(){
    const t = document.getElementById('f_turno').value;
    let i = t === "Ma√±ana" ? 6 : 14; let f = t === "Ma√±ana" ? 14 : 22;
    let html = `<option value="">--:--</option>`;
    for (let h = i; h <= f; h++) {
        for (let m = 0; m < 60; m += 5) {
            if (h === f && m > 0) break;
            let hh = String(h).padStart(2,"0") + ":" + String(m).padStart(2,"0");
            html += `<option>${hh}</option>`;
        }
    }
    return html;
}

function resetHoras(){ document.querySelectorAll("#t-tareas select.p, #t-tareas select.a").forEach(s => s.innerHTML = genH()); }

/* FUNCI√ìN DE ENV√çO UNIFICADA */
async function enviarTodo(){
    const btn = event.target;
    const original = btn.innerText;
    
    // Obtener datos cabecera
    const rawFecha = document.getElementById("f_fecha").value;
    const [y,m,d] = rawFecha.split("-");
    const fecha = `${d}/${m}/${y}`;
    const turno = document.getElementById("f_turno").value;
    const lote = document.getElementById("f_lote")?.value || "N/A";

    let payload = {
        accion: "enviarTodo",
        fecha: fecha, turno: turno, operario: currentUser, lote: lote,
        parte: null, incidencias: null, recambios: null, explosiones: null
    };

    let datosAEnviar = 0;

    // 1. RECOPILAR PARTE
    const t_prod = document.getElementById("t_prod").value;
    const hmf = document.getElementById("hmf").value;
    const hpf = document.getElementById("hpf").value;
    if (t_prod || hmf || hpf) {
        if (!t_prod) { alert("En el parte de trabajo faltan las toneladas."); return; }
        payload.parte = { h_mol_fin: hmf, h_prod_fin: hpf, t_prod: t_prod };
        datosAEnviar++;
    }

    // 2. RECOPILAR INCIDENCIAS
    const filasTareas = Array.from(document.querySelectorAll("#t-tareas tbody tr"));
    let errorHora = false;
    let tareasValidas = filasTareas.map(tr => {
        const p = tr.querySelector(".p").value;
        const a = tr.querySelector(".a").value;
        if (p && a && p > a) { 
            alert(`Error en Incidencias: Parada (${p}) posterior al arranque (${a}).`); 
            errorHora = true; 
        }
        return {
            p: p, a: a,
            t: tr.cells[2].querySelector("select").value, 
            ac: tr.cells[3].querySelector("select").value,
            o: tr.querySelector(".obs").value
        };
    }).filter(t => t.p !== "" && t.a !== ""); // Solo cuenta si tienen horas puestas

    if(errorHora) return; 
    if(tareasValidas.length > 0) {
        payload.incidencias = tareasValidas;
        datosAEnviar++;
    }

    // 3. RECOPILAR RECAMBIOS
    let recambiosValidos = Array.from(document.querySelectorAll("#t-recambios tbody tr"))
        .map(tr => ({
            item: tr.querySelector(".r-item").value, 
            cant: tr.querySelector(".r-cant").value,
            detalles: Array.from(tr.querySelectorAll(".pos-row")).map(r => ({
                pos: r.querySelector(".pos-input").value, prov: r.querySelector(".prov-input").value
            }))
        })).filter(r => r.item !== "" && r.cant > 0); // Solo cuenta si seleccion√≥ un √≠tem y puso cantidad

    if(recambiosValidos.length > 0) {
        payload.recambios = recambiosValidos;
        datosAEnviar++;
    }

    // 4. RECOPILAR EXPLOSIONES
    const exp_material = document.getElementById("exp_material").value;
    const exp_tipo = document.getElementById("exp_tipo").value;
    const exp_estallido = document.getElementById("exp_estallido").value;
    const exp_fuego = document.getElementById("exp_fuego").value;

    if (exp_material || exp_tipo || exp_estallido || exp_fuego) {
        if (!exp_material || !exp_tipo || !exp_estallido || !exp_fuego) {
            alert("Has empezado a rellenar un incidente (Explosi√≥n). Por favor, rellena todos sus campos obligatorios o b√≥rralos si ha sido un error."); 
            return;
        }
        payload.explosiones = {
            material: exp_material,
            origen: document.getElementById("exp_origen").value,
            tipoExp: exp_tipo,
            estallido: exp_estallido,
            fuego: exp_fuego,
            parada: document.getElementById("exp_parada").value, 
            danos: document.getElementById("exp_danos").value,
            obs: document.getElementById("exp_obs").value
        };
        datosAEnviar++;
    }

    // PREVENCI√ìN DE ENV√çO VAC√çO
    if (datosAEnviar === 0) {
        alert("No hay ning√∫n dato v√°lido en las pesta√±as para enviar. Revisa que hayas rellenado las horas de incidencia, cantidad de recambio o toneladas.");
        return;
    }

    if (!confirm(`Se van a enviar los datos detectados en ${datosAEnviar} pesta√±a(s). ¬øContinuar?`)) return;

    // PROCEDER AL ENV√çO
    btn.disabled = true; btn.innerText = "Enviando todos los datos...";

    try {
        await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
        alert("‚úî Datos enviados y guardados correctamente");

        // Limpiar pantallas enviadas
        if (payload.parte) {
            ["f_lote","hmf","hpf","t_prod"].forEach(id => { const e = document.getElementById(id); if(e) e.value = ""; });
            setTimeout(cargarHistorialProd, 1500);
        }
        if (payload.incidencias) {
            document.querySelector("#t-tareas tbody").innerHTML = ""; addFila();
            setTimeout(cargarIncidenciasHoy, 1500);
        }
        if (payload.recambios) {
            document.querySelector("#t-recambios tbody").innerHTML = ""; addRecambio();
        }
        if (payload.explosiones) {
            ["exp_material","exp_origen","exp_danos","exp_obs","exp_tipo","exp_estallido","exp_fuego"].forEach(id => document.getElementById(id).value = "");
            document.getElementById("exp_parada").value = "1";
        }

    } catch (e){ alert("Error enviando los datos de las pesta√±as."); }

    btn.disabled = false; btn.innerText = original;
}

function renderAdmin(){
    document.getElementById("user-tag").innerText = "‚öôÔ∏è ADMINISTRADOR";
    document.getElementById("view").innerHTML = `
        <div class="card">
            <div class="section-title">Gesti√≥n de Maestros</div>
            <div style="display:grid; grid-template-columns:1fr 1fr 1.3fr; gap:15px;">
                <div><label>Nueva Tarea</label><input id="nT" class="full-w" style="margin-bottom:5px"><button class="btn btn-blue" onclick="addExt('addTarea','nT')">A√±adir</button></div>
                <div><label>Nuevo Activo</label><input id="nA" class="full-w" style="margin-bottom:5px"><button class="btn btn-blue" onclick="addExt('addActivo','nA')">A√±adir</button></div>
                <div><label>Nuevo Operario</label><div style="display:flex; gap:5px; margin-bottom:5px;"><input id="nOp" placeholder="usuario" class="full-w"><input id="pOp" placeholder="pass" class="full-w"></div><button class="btn btn-green" onclick="addOperario()">Crear</button></div>
            </div>
        </div>
        <div class="card">
            <div class="section-title">Hist√≥rico de Parte</div>
            <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                <div><label>Desde</label><br><input type="date" id="f_ini"></div>
                <div><label>Hasta</label><br><input type="date" id="f_fin"></div>
                <button class="btn btn-blue" onclick="generarReporte()">CONSULTAR</button>
                <button id="btnDownload" class="btn btn-green" style="display:none;" onclick="descargarCSV()">DESCARGAR EXCEL</button>
            </div>
            <div style="margin-top:20px; border:1px solid #eee; max-height:350px; overflow-y:auto;"><div id="report-output"></div></div>
        </div>
    `;
}

function renderJordi(){
    document.getElementById("user-tag").innerText = "üìä CM: JORDI";
    document.getElementById("view").innerHTML = `
        <div class="card">
            <div class="section-title">Resumen de Producci√≥n (Neto x0.61)</div>
            <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                <div><label>Desde</label><br><input type="date" id="f_ini"></div>
                <div><label>Hasta</label><br><input type="date" id="f_fin"></div>
                <button class="btn btn-blue" onclick="generarReporte()">CONSULTAR</button>
            </div>
            <div style="margin-top:20px; border:1px solid #eee; max-height:350px; overflow-y:auto;"><div id="report-output"></div></div>
        </div>
    `;
}

async function addExt(acc, inp){
    const val = document.getElementById(inp).value; if (!val) return;
    fetch(SCRIPT_URL, { method:"POST", mode:"no-cors", body:JSON.stringify({accion:acc, valor:val}) });
    alert("Guardado"); document.getElementById(inp).value = "";
}

async function addOperario(){
    const nombre = document.getElementById("nOp").value.toLowerCase().trim();
    const pass = document.getElementById("pOp").value;
    if (!nombre || !pass) return;
    fetch(SCRIPT_URL, { method:"POST", mode:"no-cors", body:JSON.stringify({accion:"addOperario", nombre, pass}) });
    alert("Operario creado"); document.getElementById("nOp").value = ""; document.getElementById("pOp").value = "";
}

async function generarReporte(){
    const fini = document.getElementById("f_ini").value; 
    const ffin = document.getElementById("f_fin").value; 
    const out = document.getElementById("report-output");
    
    if (!fini || !ffin) return;
    
    out.innerHTML = "<div style='padding:20px; text-align:center; color:gray'>Consultando...</div>"; 
    
    if(currentUser !== 'jordi') {
         document.getElementById("btnDownload").style.display = "none";
    }

    try {
        const res = await fetch(SCRIPT_URL + "?action=getReport"); 
        const dataRows = await res.json(); 
        reporteActual = [];
        const finiD = new Date(fini); 
        const ffinD = new Date(ffin);
        
        let html = "";

        // ============ VISTA JORDI ============
        if (currentUser === 'jordi') {
            html = `<table style="width:100%;"><thead><tr><th>Fecha</th><th>Prod. Neta (t)</th></tr></thead><tbody>`;
            dataRows.forEach(r => {
                const [dd,mm,yy] = r[0].split("/"); 
                const d = new Date(`${yy}-${mm}-${dd}`);
                if (d >= finiD && d <= ffinD) {
                    let valNeto = r[8]; 
                    if(!valNeto || valNeto.toString().startsWith("=")) valNeto = "Calc..."; 
                    let num = parseFloat(valNeto);
                    if(!isNaN(num)) valNeto = num.toFixed(2);
                    html += `<tr><td>${r[0]}</td><td style="color:var(--blue); font-weight:bold;">${valNeto} t</td></tr>`;
                }
            });
        } 
        // ============ VISTA ADMIN (COMPLETA) ============
        else {
            html = `<table style="min-width:900px;"><thead><tr><th>Fecha</th><th>Turno</th><th>Operario</th><th>Lote</th><th>H Mol F</th><th>H Prod F</th><th>Lectura</th><th>Prod Turno</th><th>Prod Neta</th></tr></thead><tbody>`;
            dataRows.forEach(r => {
                const [dd,mm,yy] = r[0].split("/"); 
                const d = new Date(`${yy}-${mm}-${dd}`);
                if (d >= finiD && d <= ffinD) { 
                    reporteActual.push(r); 
                    html += `<tr>
                        <td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td>
                        <td>${r[4]}</td><td>${r[5]}</td><td>${r[6]}</td>
                        <td style="font-weight:bold">${r[7]}</td><td style="color:blue">${r[8]}</td>
                    </tr>`; 
                }
            });
            if (reporteActual.length > 0) document.getElementById("btnDownload").style.display = "block";
        }
        html += "</tbody></table>"; 
        out.innerHTML = html;
        
    } catch (e) { out.innerHTML = "Error cargando datos"; }
}

function descargarCSV(){
    let csv = "sep=;\nFecha;Turno;Operario;Lote;H_Mol_F;H_Prod_F;Lectura;Prod_Turno;Prod_Neta\n";
    reporteActual.forEach(r => { csv += r.slice(0,9).join(";") + "\n"; });
    const blob = new Blob(["\ufeff" + csv], { type:"text/csv;charset=utf-8;" });
    const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "Reporte_Tradebe.csv"; link.click();
}
</script>

</body>
</html>
